{% extends 'main/project/project_base.html' %}

{% block overview_active %}active{% endblock %}
{% block project_content %}
<div class="row-fluid">
<div class="span2 infobox{% if project.is_draft%} infobox-disabled{%endif%}">
  <h3 data-bind="text: urls_collected">{{urls_collected}}</h3>
  <span>URLs collected</span>
</div>
<div class="span2 infobox{% if project.is_draft%} infobox-disabled{%endif%}">
  <h3 data-bind="text: hours_spent">{{hours_spent}}</h3>
  <span>Hours spend</span>
</div>
<div class="span2 infobox{% if project.is_draft%} infobox-disabled{%endif%}">
  <h3 data-bind="text: no_of_workers">{{no_of_workers}}</h3>
  <span>Number of workers</span>
</div>
<div class="span2 infobox{% if project.is_draft%} infobox-disabled{%endif%}">
  <h3 data-bind="text: cost">{{cost}}</h3>
  <span>Cost (USD)</span>
</div>
<div class="span2 infobox">
  <h3 data-bind="text: budget">{{budget}}</h3>
  <span>Budget (USD)</span>
</div>
<div class="span1 infobox{% if project.is_draft%} infobox-disabled{%endif%}">
  <h3><span data-bind="text: progress">{{progress}}</span>%</h3>
  <span>Progress</span>
</div>
</div>
<div class="row-fluid">
<hr>
</div>
<div class="row-fluid">
{% include 'main/project/own_workforce_links.html' %}
</div>
{% if project.is_draft %}
<div class="row-fluid">
    <p>Please review your project before starting.</p>
    <p>In order to start the project click "Activate project" on the right project submenu.</p>
</div>
{% else %}
<div class="row-fluid">
<div class="span3" id="progressGraph">
</div>
<div class="span3" id="spentGraph">
</div>
<div class="span3" id="urlGraph">
</div>
<div class="span3" id="performanceGraph">
</div>
</div>
<div class="row-fluid">
<div style="width: 20%; float: right;">
  <h3>Updates</h3>
  <div id="updates-box" data-bind="foreach: alerts">
    <div class="update-box">
      <img data-bind="attr: {src: screenshot}" class="box-img">
      <div class="box-inner">
        <span class="box-header" data-bind="text: title"></span>
        <span class="box-content" data-bind="html: content"></span>
        <span data-bind="visible: hasWorker">by <a data-bind="attr: {href: workerURL}, text: workerName"></a></span>
      </div>
    </div>
  </div>
</div>
<div style="width:80%">
  <h3>Newest Correct Voted Data</h3>
  <table class="table">
    <thead>
      <tr><td>Preview</td><td>URL</td><td>Added on</td></tr>
    </thead>
    <tbody>
      <tr><td>P</td><td>URL</td><td>Datetime</td></tr>
    </tbody>
  </table>
  <hr>
</div>
<div style="width:80%">
  <h3>Top workers</h3>
  <table class="table">
    <thead>
      <tr><td>Worker name</td><td>Links collected</td><td>Hours Spent</td></tr>
    </thead>
    <tbody>
      <tr><td>Luke Vader</td><td>542</td><td>3</td></tr>
    </tbody>
  </table>
</div>
</div>
{% endif%}
{% endblock %}

{% block javascript %}
{{ block.super }}
<script type='text/javascript' src='{{STATIC_URL}}js/knockout-2.1.0.js'></script>
<script src="{{STATIC_URL}}js/highcharts.js" type="text/javascript"></script>
<script type="text/javascript">
var progressGraph; // globally available
$(document).ready(function() {
      progressGraph = new Highcharts.Chart({
         chart: {
            renderTo: 'progressGraph',
            zoomType: 'x',
            type: 'line'
         },
         title: {
            text: 'Progress per hour'
         },
         xAxis: {
            type: 'datetime',
            maxZoom: 1 * 3600 * 1000, // an hour
         },
         yAxis: {
            title: {
              text: 'Progress'
            },
            min: 0,
            showFirstLabel: false
         },
         series: [{
            showInLegend: false,
            name: 'Progress',
            color: '#FFAAAA',
            data: [{{progress_stats|safe}}]
         }]
      });
   });
var spentGraph; // globally available
$(document).ready(function() {
      spentGraph = new Highcharts.Chart({
         chart: {
            renderTo: 'spentGraph',
            zoomType: 'x',
            type: 'line'
         },
         title: {
            text: 'Spent per hour'
         },
         xAxis: {
            type: 'datetime',
            maxZoom: 1 * 3600 * 1000, // an hour
         },
         yAxis: {
            title: {
              text: 'Spent'
            },
            min: 0,
            showFirstLabel: false
         },
         series: [{
            showInLegend: false,
            name: 'Spent',
            color: '#AAFFAA',
            data: [{{spent_stats|safe}}]
         }]
      });
   });
var urlGraph; // globally available
$(document).ready(function() {
      urlGraph = new Highcharts.Chart({
         chart: {
            renderTo: 'urlGraph',
            zoomType: 'x',
            type: 'line'
         },
         title: {
            text: 'URLs per hour'
         },
         xAxis: {
            type: 'datetime',
            maxZoom: 1 * 3600 * 1000, // an hour
         },
         yAxis: {
            title: {
              text: 'URLs'
            },
            min: 0,
            showFirstLabel: false
         },
         series: [{
            showInLegend: false,
            name: 'URLs',
            color: '#AAAAFF',
            data: [{{url_stats|safe}}]
         }]
      });
   });
var performanceGraph; // globally available
$(document).ready(function() {
      performanceGraph = new Highcharts.Chart({
         chart: {
            renderTo: 'performanceGraph',
            zoomType: 'x',
            type: 'line'
         },
         title: {
            text: 'Performance per hour'
         },
         xAxis: {
            type: 'datetime',
            maxZoom: 1 * 3600 * 1000, // an hour
         },
         yAxis: {
            title: {
              text: 'Performance'
            },
            min: 0,
            showFirstLabel: false
         },
         series: [{
            showInLegend: true,
            name: 'TPR',
            color: '#FFAAFF',
            data: [{{performance_TPR|safe}}]
         },
         {
            showInLegend: true,
            name: 'TNR',
            color: '#AAAAFF',
            data: [{{performance_TNR|safe}}]
         },
         {
            showInLegend: true,
            name: 'AUC',
            color: '#AAFFAA',
            data: [{{performance_AUC|safe}}]
         }]
      });
   });

function alert_view(screenshot, worker_id, worker_name, title, content){
  this.screenshot = screenshot;
  this.worker_id = worker_id;
  this.workerName = worker_name;
  this.title = title;
  this.content = content;

  this.hasWorker = ko.computed(function(){
    return this.worker_id;
  }, this);
  this.workerURL = ko.computed(function(){
    if (this.hasWorker())
      return '{% url project_workers_view project.id%}/'+this.worker_id+'/';
    return '';
  }, this);
}

function job_view(){
  this.urls_collected = ko.observable();
  this.progress = ko.observable();
  this.hours_spent = ko.observable();
  this.budget = ko.observable();
  this.cost = ko.observable();
  this.no_of_workers = ko.observable();
  this.gather_url = ko.observable();
  this.voting_url = ko.observable();
  this.alerts = ko.observableArray();
}

var job = new job_view();
var image_cache = {};

function updateAlerts(url){
  $.get(url+'?limit=4&format=json', function(data){
    new_alerts = [];
    // Expire cache
    $.each(image_cache, function(idx, val){
      val['active'] = false;
    })

    $.each(data['entries'], function(idx, val){
      box = val['box'];
      new_alerts.push(new alert_view(box['Image_url'], box['By_id'], box['By'], box['Title'], box['Text']));
      if (!(box['Image_url'] in image_cache)){
        img = new Image();
        img.src = box['Image_url'];
        image_cache[box['Image_url']] = {
          'img': img,
          'active': true,
        }
      } else
        image_cache[box['Image_url']]['active'] = true;
    });

    var new_cache = {};
    $.each(image_cache, function(idx, val){
      if (val['active'])
        new_cache[idx] = val;
    });
    image_cache = new_cache

    job.alerts(new_alerts);
    setTimeout('updateJob();', 10 * 1000);
  })
}

function updateJob(){
  $.get("/api/v1/job/{{project.id}}/?format=json", function(data){
    job.urls_collected(data['urls_collected']);
    job.progress(data['progress']);
    job.hours_spent(data['hours_spent']);
    job.budget(data['budget']);
    job.cost(data['cost']);
    job.no_of_workers(data['no_of_workers']);
    job.gather_url(data['sample_gathering_url']);
    job.voting_url(data['sample_voting_url']);
    updateAlerts(data['feed']);
  });
}

$(document).ready(function(){
  ko.applyBindings(job);
  updateJob();
  // getUpdatesBox();
});
</script>
{% endblock %}

{% block css %}
{{ block.super }}
<style type="text/css">
div.status-active {
  background-color: #DFF0D8;
}
div.status-completed {
  background-color: #F7F7F9;
}
div.status-draft {
  background-color: #FCF8E3;
}
div.status-stopped {
  background-color: #F2DEDE;
}
div.infobox {
  text-align: center;
  border: 1px solid #E1E1E8;
  border-radius: 4px 4px 4px 4px;
}
div.infobox-disabled {
  background-color: #F7F7F9;
  color: gray;
}
div.update-box {
  margin-bottom: 5px;
  clear: both;
}
img.box-img {
  width: 60px;
  height: 60px;
  float: left;
}
span.box-header {
  display: block;
  font-weight: bold;
}
span.box-content {
  display: block;
}
</style>
{% endblock %}
