{% extends 'base.html' %}

{% block main %}
{% if user.is_authenticated %}

<ul class="nav nav-tabs" id="admin-menu">
  <li><a href="#projects" data-toggle="tab">Projects</a></li>
  <li class="active"><a href="#updates" data-toggle="tab">Updates</a></li>
</ul>

<div class="tab-content">
  <div class="tab-pane active" id="updates">
    <div class="row-fluid">
      <h2>Updates</h2>
      <div id="updates-box">

      </div>
    </div>
  </div>
  <div class="tab-pane" id="projects" class="row-fluid">
    <div>
      <h2>Projects</h2>
    </div>
    <div class="row-fluid">
      <table class="table" style="width:100%">
        <thead>
          <tr>
            <th>Project name</th>
            <th>Status</th>
            <th>Beat the machine</th>
            <th>Links collected</th>
            <th>Hours spent</th>
            <th>Total cost (USD)</th>
            <th>Budget (USD)</th>
            <th>Classifier performance</th>
            <th>Progress</th>
          </tr>
        </thead>
        <tbody>
        {% for p in projects %}
          <tr>
            <td><a href="{% url project_view id=p.id %}">{{p.title}}</a> <a rel="tooltip" href="#" data-original-title="{{p.description}}">(i)</a></td>
            <td class="statusCol">{{p.get_status}}</td>
            <td class="beatMachineCol">--</td>
            <td class="linksCol">{{p.get_urls_collected}}</td>
            <td class="hoursSpentCol">{{p.get_hours_spent}}</td>
            <td class="totalCostCol">{{p.get_cost}}</td>
            <td class="budgetCol">{{p.budget}}</td>
            <td class="classfierCol">0</td>
            <td class="progressCol">{{p.get_progress}}%</td>
          </tr>
        {% endfor %}
        </tbody>
      </table>
      {% if not projects %}
        <span class="span5">&nbsp;</span>
        <span id="nothing-to-display" class="span4" style="font-size:120%; font-weight:bold">Nothing to display here.</span>
        <span class="span3">&nbsp;</span>
      {% endif %}
    </div>
    {% endif %}
  </div>
</div>
{% endblock %}

{% block css %}
{{ block.super }}
<style type="text/css">
td.progressCol {
  width: 30px;
}
td.classfierCol {
  width: 30px;
}
td.budgetCol {
  width: 70px;
}
td.totalCostCol {
  width: 70px;
}
td.hoursSpentCol {
  width: 70px;
}
td.linksCol {
  width: 90px;
}
td.beatMachineCol {
  width: 40px;
}
td.statusCol {
  width: 90px;
}
div.update-box {
  margin-bottom: 5px;
  clear: both;
}
img.box-img {
  width: 60px;
  height: 60px;
  float: left;
}
span.box-header {
  display: block;
  font-weight: bold;
}
span.box-content {
  display: block;
}
</style>
{% endblock %}

{% block javascript %}
{{ block.super }}
<script type="text/javascript">
$('a[rel=tooltip]').tooltip({placement: 'right'})
$('#admin-menu a').click(function (e) {
  e.preventDefault();
  $(this).tab('show');
})

function addBox(updates_box, box){
  text = [
    '<div class="update-box">',
    '<img src="'+box['Image_url']+'" class="box-img"><div class="box-inner">',
    '<span class="box-header">'+box['Title']+' in <a href="/project/'+box['Job_id']+'">job</a></span>',
    '<span class="box-content">'+box['Text']+'</span>',
  ];
  if (box['by'] != undefined){
    text.push('<span>by <a href="/project/'+box['Job_id']+'/workers/'+box['By-id']+'">'+box['By']+'</a></span>');
  }
  text.push('</div></div>')
  updates_box.append(text.join(''))
};

function getUpdatesBox(){
  $.get('{% url updates_box_view 0 %}', function(data){
    data = JSON.parse(data);
    $('.update-box').remove();
    box = $('#updates-box');
    for (alert in data){
      addBox(box, data[alert]);
    }
    setTimeout('getUpdatesBox()', 5 * 1000);
  })

};

getUpdatesBox()
</script>
{% endblock %}
